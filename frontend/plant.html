<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant - RedBuds App</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <div id="navigation"></div>

    <div class="container mx-auto px-4 py-8">

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">Loading plant...</p>
        </div>

        <!-- Plant content -->
        <div id="plant-content" class="hidden">
            <!-- Header with link back to accession page -->
            <div class="mb-6">
                <a href="#" id="back-to-accession" class="text-blue-600 hover:underline">‚Üê Back to Accession</a>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="plant-id" class="text-3xl font-bold text-gray-800"></h2>
                    <div class="flex gap-2">
                        <button id="edit-plant-btn" onclick="openEditPlantModal()" class="hidden bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Edit
                        </button>
                        <button id="delete-plant-btn" onclick="deletePlant()" class="hidden bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Delete
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">
                            <span id="species-or-hybrid-label">Species</span>
                        </h3>
                        <!-- Non-hybrid species display -->
                        <div id="species-display">
                            <p class="text-gray-600">
                                <a href="#" id="species-link" class="text-blue-600 hover:underline">
                                    <span id="species-genus"></span>
                                    <span id="species-name"></span>
                                    <span id="species-variety" class="text-gray-600"></span>
                                </a>
                            </p>
                            <p id="species-common-name" class="text-sm text-gray-500 mt-1"></p>
                        </div>
                        <!-- Hybrid display -->
                        <div id="hybrid-display" class="hidden">
                            <p class="text-gray-600">
                                <span class="inline-block bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded mb-2">Hybrid</span>
                            </p>
                            <p class="text-gray-800 font-medium" id="hybrid-name"></p>
                            <div class="mt-2 text-sm text-gray-600">
                                <p>Parent 1: <span id="parent-1-name"></span></p>
                                <p>Parent 2: <span id="parent-2-name"></span></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Accession</h3>
                        <p class="text-gray-600">
                            <a href="#" id="accession-link" class="text-blue-600 hover:underline">
                                <span id="accession-name"></span>
                            </a>
                        </p>
                    </div>
                </div>

                <!-- Location Section (Compact) -->
                <div id="location-section" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Location</h3>
                    <div id="location-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Location info will be rendered here -->
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-500">
                        Created: <span id="plant-created"></span>
                    </p>
                </div>
            </div>

            <!-- Custom Fields Section -->
            <div id="custom-fields-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Custom Plant Fields</h3>
                <div id="custom-fields-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Custom fields will be rendered here -->
                </div>
            </div>

            <!-- Events Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Events</h3>
                    <button onclick="openAddEventModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Add Event
                    </button>
                </div>

                <div id="events-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="mt-2 text-gray-600">Loading events...</p>
                </div>

                <div id="events-content" class="hidden">
                    <div id="events-empty" class="text-center py-8 text-gray-600 hidden">
                        No events recorded yet. Click "Add Event" to record the first event for this plant.
                    </div>

                    <div id="events-timeline" class="space-y-4">
                        <!-- Events will be rendered here as timeline -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Plant Modal -->
    <div id="edit-plant-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="if(event.target === this) closeEditPlantModal()">
        <div class="relative top-10 mx-auto p-5 border w-auto max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Plant</h3>
                <form id="edit-plant-form">
                    <!-- Plant ID -->
                    <div class="mb-4">
                        <label for="edit-plant-id" class="block text-sm font-medium text-gray-700 mb-1">Plant ID *</label>
                        <input type="text" id="edit-plant-id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Location Type Selection -->
                    <div class="mb-4">
                        <label for="edit-location-type-select" class="block text-sm font-medium text-gray-700 mb-1">Location Type</label>
                        <select id="edit-location-type-select" onchange="handleLocationTypeChange()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">No location assigned</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">Select a location type and fill in the details</p>
                    </div>

                    <!-- Location Fields (dynamic based on selected type) -->
                    <div id="edit-location-fields-container" class="hidden mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Location Details</h4>
                        <div class="mb-3">
                            <label for="edit-location-notes" class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="edit-location-notes" rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div id="edit-location-fields" class="space-y-3">
                            <!-- Dynamic fields will be added here -->
                        </div>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeEditPlantModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="if(event.target === this) closeAddEventModal()">
        <div class="relative top-10 mx-auto p-5 border w-auto max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add Event</h3>
                <form id="add-event-form">
                    <!-- Event Type Selection -->
                    <div class="mb-4">
                        <label for="event-type-select" class="block text-sm font-medium text-gray-700 mb-1">Event Type *</label>
                        <select id="event-type-select" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select an event type...</option>
                        </select>
                    </div>

                    <!-- Event Date -->
                    <div class="mb-4">
                        <label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">Event Date & Time *</label>
                        <input type="datetime-local" id="event-date" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Dynamic Fields Container -->
                    <div id="event-fields-container" class="hidden mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Event Data</h4>
                        <div id="event-fields" class="space-y-3">
                            <!-- Dynamic fields will be added here -->
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-4">
                        <label for="event-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="event-notes" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeAddEventModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Save Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/router.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/navigation.js"></script>
    <script>
        let currentUser = null;
        let organizationId = null;
        let speciesId = null;
        let accessionId = null;
        let plantId = null;
        let plant = null;
        let events = [];
        let accessibleEventTypes = [];
        let selectedEventType = null;
        let locationTypes = [];
        let selectedLocationType = null;

        async function init() {
            currentUser = await Auth.checkAuth();
            if (!currentUser) return;

            const { orgId, plantId: pId } = getPathParams();
            organizationId = orgId;
            plantId = pId;

            if (!organizationId || !plantId) {
                showError('Missing required parameters');
                return;
            }

            // Fetch organization for navigation
            let organizationName = null;
            try {
                const org = await api.getOrganization(organizationId);
                organizationName = org.name;
            } catch (error) {
                console.error('Failed to load organization:', error);
            }

            // Render navigation with organization context
            document.getElementById('navigation').innerHTML = navigation.render({
                showOrgDropdown: true,
                orgDropdownId: organizationId,
                organizationName: organizationName
            });
            navigation.init(currentUser, {
                showOrgDropdown: true,
                orgDropdownId: organizationId
            });
            document.getElementById('footer').innerHTML = navigation.renderFooter();

            await loadPlant();
            await loadEvents();
            await loadLocationTypes();

            // Set back link (after loading plant to get accessionId)
            document.getElementById('back-to-accession').href = buildUrl('organizations', organizationId, 'accessions', accessionId);

            // Check for query parameter to auto-open Add Event modal (for QR code scanning)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('addEvent') === 'true') {
                openAddEventModal();
            }
        }

        async function loadPlant() {
            try {
                plant = await api.getOrgPlant(organizationId, plantId);

                // Extract speciesId and accessionId from the plant
                speciesId = plant.species_id;
                accessionId = plant.accession_id;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('plant-content').classList.remove('hidden');

                // Display plant ID
                document.getElementById('plant-id').textContent = plant.plant_id;

                // Display species or hybrid information
                if (plant.is_hybrid && plant.hybrid_display_name) {
                    // Show hybrid display
                    document.getElementById('species-or-hybrid-label').textContent = 'Hybrid';
                    document.getElementById('species-display').classList.add('hidden');
                    document.getElementById('hybrid-display').classList.remove('hidden');
                    document.getElementById('hybrid-name').textContent = plant.hybrid_display_name;
                    document.getElementById('parent-1-name').textContent = plant.parent_species_1_name || 'Unknown';
                    document.getElementById('parent-2-name').textContent = plant.parent_species_2_name || 'Unknown';
                } else {
                    // Show normal species display
                    document.getElementById('species-display').classList.remove('hidden');
                    document.getElementById('hybrid-display').classList.add('hidden');

                    document.getElementById('species-genus').textContent = plant.species_genus;
                    document.getElementById('species-name').textContent = ' ' + plant.species_name;

                    if (plant.species_variety) {
                        document.getElementById('species-variety').textContent = ' var. ' + plant.species_variety;
                    }

                    if (plant.species_common_name) {
                        document.getElementById('species-common-name').textContent = plant.species_common_name;
                    } else {
                        document.getElementById('species-common-name').classList.add('hidden');
                    }

                    // Set species link
                    document.getElementById('species-link').href = buildUrl('organizations', organizationId, 'species', speciesId);
                }

                // Display accession information
                document.getElementById('accession-name').textContent = plant.accession;
                document.getElementById('accession-link').href = buildUrl('organizations', organizationId, 'accessions', accessionId);

                // Display created date
                document.getElementById('plant-created').textContent = formatDate(plant.created_at);

                // Display location if present
                if (plant.location) {
                    renderLocation(plant.location);
                }

                // Display custom fields if present
                if (plant.field_values && plant.field_values.length > 0) {
                    renderCustomFields(plant.field_values);
                }

                // Show edit/delete buttons if user is admin or site admin
                const org = await api.getOrganization(organizationId);
                const isAdmin = org.members.some(m => m.user_id === currentUser.id && m.role === 'admin' && m.status === 'Active');
                if (currentUser.is_site_admin || isAdmin) {
                    document.getElementById('edit-plant-btn').classList.remove('hidden');
                    document.getElementById('delete-plant-btn').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError(error.message || 'Failed to load plant');
            }
        }

        async function deletePlant() {
            if (!confirm(`Are you sure you want to delete plant "${plant.plant_id}"? This will also delete all associated events. This action cannot be undone.`)) {
                return;
            }

            try {
                await api.deletePlant(organizationId, speciesId, accessionId, plantId);
                showSuccess('Plant deleted successfully!');
                // Redirect back to accession page
                window.location.href = buildUrl('organizations', organizationId, 'accessions', accessionId);
            } catch (error) {
                showError(error.message || 'Failed to delete plant');
            }
        }

        function renderLocation(location) {
            const section = document.getElementById('location-section');
            const content = document.getElementById('location-content');

            section.classList.remove('hidden');

            // Extract latitude and longitude for Google Maps link
            let latitude = null;
            let longitude = null;
            let html = '';

            // Render location type badge
            html += `
                <div class="col-span-full mb-2">
                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                        ${location.location_type_name}
                    </span>
                </div>
            `;

            // Render field values in compact grid
            if (location.field_values && location.field_values.length > 0) {
                location.field_values.forEach(field => {
                    // Track latitude and longitude
                    if (field.field_name === 'Latitude' && field.value) {
                        latitude = field.value;
                    }
                    if (field.field_name === 'Longitude' && field.value) {
                        longitude = field.value;
                    }

                    const displayValue = field.value !== null && field.value !== undefined
                        ? field.value
                        : '<span class="text-gray-400 italic">Not set</span>';

                    html += `
                        <div>
                            <p class="text-xs font-medium text-gray-500">${field.field_name}</p>
                            <p class="text-sm text-gray-900">${displayValue}</p>
                        </div>
                    `;
                });
            }

            // Add notes if present
            if (location.notes) {
                html += `
                    <div class="col-span-full">
                        <p class="text-xs font-medium text-gray-500">Notes</p>
                        <p class="text-sm text-gray-900">${location.notes}</p>
                    </div>
                `;
            }

            // Add Google Maps link if we have both latitude and longitude
            if (latitude !== null && longitude !== null) {
                const mapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                html += `
                    <div class="col-span-full">
                        <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer"
                           class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            View on Google Maps
                        </a>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function renderCustomFields(fieldValues) {
            const section = document.getElementById('custom-fields-section');
            const content = document.getElementById('custom-fields-content');

            if (fieldValues.length === 0) {
                return; // Don't show the section if there are no custom fields defined
            }

            section.classList.remove('hidden');

            content.innerHTML = fieldValues.map(field => {
                const displayValue = field.value !== null ? field.value : '<span class="text-gray-400 italic">Not set</span>';

                return `
                    <div class="border-b border-gray-200 pb-2">
                        <h4 class="text-sm font-semibold text-gray-700">${field.field_name}</h4>
                        <p class="text-gray-600">${displayValue}</p>
                    </div>
                `;
            }).join('');
        }

        // Events Management
        async function loadEvents() {
            try {
                events = await api.getPlantEvents(organizationId, speciesId, accessionId, plantId);
                accessibleEventTypes = await api.getAccessibleEventTypes(organizationId, speciesId, accessionId, plantId);

                document.getElementById('events-loading').classList.add('hidden');
                document.getElementById('events-content').classList.remove('hidden');

                if (events.length > 0) {
                    renderEventsTimeline(events);
                    document.getElementById('events-empty').classList.add('hidden');
                } else {
                    document.getElementById('events-empty').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load events:', error);
                document.getElementById('events-loading').classList.add('hidden');
                document.getElementById('events-content').classList.remove('hidden');
                document.getElementById('events-empty').classList.remove('hidden');
            }
        }

        function renderEventsTimeline(eventsList) {
            const timeline = document.getElementById('events-timeline');
            timeline.innerHTML = '';

            // Sort events by date descending (newest first)
            const sortedEvents = [...eventsList].sort((a, b) =>
                new Date(b.event_date) - new Date(a.event_date)
            );

            sortedEvents.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'border-l-4 border-green-500 pl-4 py-3 bg-gray-50 rounded-r';

                let fieldValuesHtml = '';
                if (event.field_values && event.field_values.length > 0) {
                    fieldValuesHtml = `
                        <div class="mt-2 space-y-1">
                            ${event.field_values.map(fv => `
                                <div class="text-sm">
                                    <span class="font-medium text-gray-700">${fv.field_name}:</span>
                                    <span class="text-gray-600">${fv.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                let notesHtml = '';
                if (event.notes) {
                    notesHtml = `
                        <div class="mt-2 text-sm text-gray-600 italic">
                            ${event.notes}
                        </div>
                    `;
                }

                eventCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${event.event_type_name}</h4>
                            <p class="text-sm text-gray-500">${formatDate(event.event_date)}</p>
                            ${fieldValuesHtml}
                            ${notesHtml}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="deleteEvent('${event.id}', '${event.event_type_name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                Delete
                            </button>
                        </div>
                    </div>
                `;

                timeline.appendChild(eventCard);
            });
        }

        function openAddEventModal() {
            // Populate event types dropdown
            const select = document.getElementById('event-type-select');
            select.innerHTML = '<option value="">Select an event type...</option>';

            accessibleEventTypes.forEach(eventType => {
                const option = document.createElement('option');
                option.value = eventType.id;
                option.textContent = eventType.event_name;
                option.dataset.eventType = JSON.stringify(eventType);
                select.appendChild(option);
            });

            // Set default date to now
            const now = new Date();
            const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('event-date').value = localDateTime;

            // Clear other fields
            document.getElementById('event-notes').value = '';
            document.getElementById('event-fields').innerHTML = '';
            document.getElementById('event-fields-container').classList.add('hidden');

            selectedEventType = null;
            document.getElementById('add-event-modal').classList.remove('hidden');
        }

        function closeAddEventModal() {
            document.getElementById('add-event-modal').classList.add('hidden');
            selectedEventType = null;
        }

        // Handle event type selection change
        document.getElementById('event-type-select').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];

            if (!selectedOption.value) {
                document.getElementById('event-fields-container').classList.add('hidden');
                selectedEventType = null;
                return;
            }

            selectedEventType = JSON.parse(selectedOption.dataset.eventType);

            const fieldsContainer = document.getElementById('event-fields');
            fieldsContainer.innerHTML = '';

            if (selectedEventType.fields && selectedEventType.fields.length > 0) {
                document.getElementById('event-fields-container').classList.remove('hidden');

                selectedEventType.fields.forEach(field => {
                    const fieldDiv = document.createElement('div');

                    if (field.field_type === 'string') {
                        fieldDiv.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${field.is_required ? '*' : ''}
                            </label>
                            <input type="text" data-field-id="${field.id}" data-field-type="string"
                                ${field.is_required ? 'required' : ''}
                                ${field.min_length ? `minlength="${field.min_length}"` : ''}
                                ${field.max_length ? `maxlength="${field.max_length}"` : ''}
                                ${field.regex_pattern ? `pattern="${field.regex_pattern}"` : ''}
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        `;
                    } else if (field.field_type === 'number') {
                        fieldDiv.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${field.is_required ? '*' : ''}
                            </label>
                            <input type="number" data-field-id="${field.id}" data-field-type="number"
                                ${field.is_required ? 'required' : ''}
                                ${field.min_value !== null && field.min_value !== undefined ? `min="${field.min_value}"` : ''}
                                ${field.max_value !== null && field.max_value !== undefined ? `max="${field.max_value}"` : ''}
                                step="any"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        `;
                    }

                    fieldsContainer.appendChild(fieldDiv);
                });
            } else {
                document.getElementById('event-fields-container').classList.add('hidden');
            }
        });

        document.getElementById('add-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const eventTypeId = document.getElementById('event-type-select').value;
            const eventDate = document.getElementById('event-date').value;
            const notes = document.getElementById('event-notes').value.trim();

            // Collect field values
            const fieldInputs = document.querySelectorAll('#event-fields input');
            const fieldValues = [];

            fieldInputs.forEach(input => {
                const fieldId = input.dataset.fieldId;
                const fieldType = input.dataset.fieldType;
                const rawValue = input.value.trim();

                if (rawValue) {
                    const value = fieldType === 'number' ? parseFloat(rawValue) : rawValue;
                    fieldValues.push({
                        field_id: fieldId,
                        value: value
                    });
                }
            });

            const data = {
                event_type_id: eventTypeId,
                event_date: new Date(eventDate).toISOString(),
                notes: notes || null,
                field_values: fieldValues
            };

            try {
                await api.createPlantEvent(organizationId, speciesId, accessionId, plantId, data);
                showSuccess('Event recorded successfully!');
                closeAddEventModal();
                await loadEvents();
            } catch (error) {
                showError(error.message || 'Failed to record event');
            }
        });

        async function deleteEvent(eventId, eventTypeName) {
            if (!confirm(`Are you sure you want to delete this ${eventTypeName} event?`)) {
                return;
            }

            try {
                await api.deletePlantEvent(organizationId, speciesId, accessionId, plantId, eventId);
                showSuccess('Event deleted successfully!');
                await loadEvents();
            } catch (error) {
                showError(error.message || 'Failed to delete event');
            }
        }

        // Load all location types for the organization
        async function loadLocationTypes() {
            try {
                locationTypes = await api.getOrganizationLocationTypes(organizationId);
            } catch (error) {
                console.error('Failed to load location types:', error);
            }
        }

        // Handle location type change
        function handleLocationTypeChange() {
            const locationTypeId = document.getElementById('edit-location-type-select').value;
            const fieldsContainer = document.getElementById('edit-location-fields-container');
            const fieldsDiv = document.getElementById('edit-location-fields');

            if (!locationTypeId) {
                fieldsContainer.classList.add('hidden');
                fieldsDiv.innerHTML = '';
                selectedLocationType = null;
                return;
            }

            selectedLocationType = locationTypes.find(lt => lt.id === locationTypeId);
            if (!selectedLocationType) return;

            fieldsContainer.classList.remove('hidden');
            fieldsDiv.innerHTML = '';

            // Render fields for this location type
            selectedLocationType.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mb-2';

                const label = document.createElement('label');
                label.className = 'block text-xs font-medium text-gray-700 mb-1';
                label.textContent = field.field_name + (field.is_required ? ' *' : '');

                let inputElement;

                if (field.field_type === 'select') {
                    // Create select dropdown for SELECT fields
                    inputElement = document.createElement('select');
                    inputElement.id = `location-field-${field.id}`;
                    inputElement.dataset.fieldId = field.id;
                    inputElement.dataset.fieldType = field.field_type;
                    inputElement.className = 'w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500';

                    if (field.is_required) {
                        inputElement.required = true;
                    }

                    // Add blank option
                    const blankOption = document.createElement('option');
                    blankOption.value = '';
                    blankOption.textContent = 'Select...';
                    inputElement.appendChild(blankOption);

                    // Add options from field_options
                    if (field.field_options && Array.isArray(field.field_options)) {
                        field.field_options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            inputElement.appendChild(optionElement);
                        });
                    }
                } else {
                    // Create input for STRING or NUMBER fields
                    inputElement = document.createElement('input');
                    inputElement.type = field.field_type === 'number' ? 'number' : 'text';
                    inputElement.id = `location-field-${field.id}`;
                    inputElement.dataset.fieldId = field.id;
                    inputElement.dataset.fieldType = field.field_type;
                    inputElement.className = 'w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500';

                    if (field.is_required) {
                        inputElement.required = true;
                    }

                    if (field.field_type === 'number') {
                        if (field.min_value !== null) inputElement.min = field.min_value;
                        if (field.max_value !== null) inputElement.max = field.max_value;
                        inputElement.step = 'any';
                    } else {
                        if (field.min_length) inputElement.minLength = field.min_length;
                        if (field.max_length) inputElement.maxLength = field.max_length;
                    }
                }

                fieldDiv.appendChild(label);
                fieldDiv.appendChild(inputElement);
                fieldsDiv.appendChild(fieldDiv);
            });
        }

        // Open edit plant modal
        function openEditPlantModal() {
            // Populate form with current plant data
            document.getElementById('edit-plant-id').value = plant.plant_id;

            // Populate location types dropdown
            const locationTypeSelect = document.getElementById('edit-location-type-select');
            locationTypeSelect.innerHTML = '<option value="">No location assigned</option>';

            locationTypes.forEach(locationType => {
                const option = document.createElement('option');
                option.value = locationType.id;
                option.textContent = locationType.location_name;
                locationTypeSelect.appendChild(option);
            });

            // If plant has a location, populate the fields
            if (plant.location) {
                locationTypeSelect.value = plant.location.location_type_id;
                handleLocationTypeChange();

                // Wait for next tick to populate fields
                setTimeout(() => {
                    document.getElementById('edit-location-notes').value = plant.location.notes || '';

                    plant.location.field_values.forEach(fv => {
                        const input = document.getElementById(`location-field-${fv.field_id}`);
                        if (input) {
                            input.value = fv.value;
                        }
                    });
                }, 0);
            }

            document.getElementById('edit-plant-modal').classList.remove('hidden');
        }

        function closeEditPlantModal() {
            document.getElementById('edit-plant-modal').classList.add('hidden');
        }

        // Handle edit plant form submission
        document.getElementById('edit-plant-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const plantIdValue = document.getElementById('edit-plant-id').value.trim();
            const locationTypeId = document.getElementById('edit-location-type-select').value;

            try {
                let locationId = null;

                // If a location type is selected, create or update the location
                if (locationTypeId && selectedLocationType) {
                    // Auto-generate location name from plant ID
                    const locationName = `Location for ${plantIdValue}`;
                    const locationNotes = document.getElementById('edit-location-notes').value.trim();

                    // Collect field values
                    const fieldValues = [];
                    selectedLocationType.fields.forEach(field => {
                        const input = document.getElementById(`location-field-${field.id}`);
                        if (input) {
                            const value = input.value.trim();
                            if (value) {
                                fieldValues.push({
                                    field_id: field.id,
                                    value: field.field_type === 'NUMBER' ? parseFloat(value) : value
                                });
                            } else if (field.is_required) {
                                throw new Error(`${field.field_name} is required`);
                            }
                        }
                    });

                    // Check if plant already has a location
                    if (plant.location) {
                        // Update existing location
                        await api.updateLocation(organizationId, plant.location.id, {
                            location_type_id: locationTypeId,
                            location_name: locationName,
                            notes: locationNotes || null,
                            field_values: fieldValues
                        });
                        locationId = plant.location.id;
                    } else {
                        // Create new location
                        const newLocation = await api.createLocation(organizationId, {
                            location_type_id: locationTypeId,
                            location_name: locationName,
                            notes: locationNotes || null,
                            field_values: fieldValues
                        });
                        locationId = newLocation.id;
                    }
                } else if (plant.location) {
                    // Location type was cleared - set location_id to null
                    locationId = null;
                }

                // Update plant with new location_id
                const updateData = {
                    plant_id: plantIdValue,
                    location_id: locationId
                };

                await api.updateOrgPlant(organizationId, plantId, updateData);
                showSuccess('Plant updated successfully!');
                closeEditPlantModal();

                // Reload plant data
                await loadPlant();
            } catch (error) {
                showError(error.message || 'Failed to update plant');
            }
        });

        init();
    </script>
    <!-- Footer -->
    <div id="footer"></div>

</body>
</html>
