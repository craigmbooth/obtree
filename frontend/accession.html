<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accession - RedBuds App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <div id="navigation"></div>

    <div class="container mx-auto px-4 py-8">

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">Loading accession...</p>
        </div>

        <!-- Accession content -->
        <div id="accession-content" class="hidden">
            <!-- Header with link back to species page -->
            <div class="mb-6">
                <a href="#" id="back-to-species" class="text-blue-600 hover:underline">‚Üê Back to Species</a>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 id="accession-id" class="text-3xl font-bold text-gray-800 mb-4"></h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Species</h3>
                        <p class="text-gray-600">
                            <a href="#" id="species-link" class="text-blue-600 hover:underline">
                                <span id="species-genus"></span>
                                <span id="species-name"></span>
                                <span id="species-variety" class="text-gray-600"></span>
                            </a>
                        </p>
                        <p id="species-common-name" class="text-sm text-gray-500 mt-1"></p>
                    </div>

                    <div id="project-container" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Project</h3>
                        <p class="text-gray-600">
                            <a href="#" id="project-link" class="text-blue-600 hover:underline">
                                <span id="project-title"></span>
                            </a>
                        </p>
                    </div>
                </div>

                <div id="description-container" class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Description</h3>
                    <p id="accession-description" class="text-gray-600">No description provided.</p>
                </div>

                <!-- Custom Fields Section -->
                <div id="custom-fields-section" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Custom Fields</h3>
                    <div id="custom-fields-display" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- Plants Section -->
                <div id="plants-section" class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Plants</h3>
                        <button onclick="openAddPlantModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            Add Plant
                        </button>
                    </div>

                    <!-- Plants List -->
                    <div id="plants-list">
                        <p class="text-gray-500 italic">Loading plants...</p>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-500">
                        Created: <span id="accession-created"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Plant Modal -->
    <div id="add-plant-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="if(event.target === this) closeAddPlantModal()">
        <div class="relative top-10 mx-auto p-5 border w-auto max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Plant</h3>
                <form id="add-plant-form">
                    <!-- Plant ID -->
                    <div class="mb-4">
                        <label for="new-plant-id" class="block text-sm font-medium text-gray-700 mb-1">Plant ID *</label>
                        <input type="text" id="new-plant-id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Location Type Selection -->
                    <div class="mb-4">
                        <label for="new-location-type-select" class="block text-sm font-medium text-gray-700 mb-1">Location Type (Optional)</label>
                        <select id="new-location-type-select" onchange="handleNewPlantLocationTypeChange()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">No location assigned</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">Select a location type and fill in the details</p>
                    </div>

                    <!-- Location Fields (dynamic based on selected type) -->
                    <div id="new-location-fields-container" class="hidden mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Location Details</h4>
                        <div id="new-location-fields" class="space-y-3 mb-3">
                            <!-- Dynamic fields will be added here -->
                        </div>
                        <div>
                            <label for="new-location-notes" class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="new-location-notes" rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeAddPlantModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Add Plant
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/router.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/navigation.js"></script>
    <script>
        let currentUser = null;
        let organizationId = null;
        let speciesId = null;
        let accessionId = null;
        let accession = null;
        let locationTypes = [];
        let selectedLocationTypeForNewPlant = null;

        async function init() {
            currentUser = await Auth.checkAuth();
            if (!currentUser) return;

            const { orgId, accessionId: aId } = getPathParams();
            organizationId = orgId;
            accessionId = aId;

            if (!organizationId || !accessionId) {
                showError('Missing required parameters');
                return;
            }

            // Fetch organization for navigation
            let organizationName = null;
            try {
                const org = await api.getOrganization(organizationId);
                organizationName = org.name;
            } catch (error) {
                console.error('Failed to load organization:', error);
            }

            // Render navigation
            document.getElementById('navigation').innerHTML = navigation.render({
                showOrgDropdown: true,
                orgDropdownId: organizationId,
                organizationName: organizationName
            });
            navigation.init(currentUser, {
                showOrgDropdown: true,
                orgDropdownId: organizationId
            });
            document.getElementById('footer').innerHTML = navigation.renderFooter();

            await loadAccession();

            // Set back link (after loading accession to get speciesId)
            document.getElementById('back-to-species').href = buildUrl('organizations', organizationId, 'species', speciesId);

            await loadPlants();
            await loadLocationTypes();
        }

        async function loadAccession() {
            try {
                accession = await api.getOrgAccession(organizationId, accessionId);

                // Extract speciesId from the accession
                speciesId = accession.species_id;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('accession-content').classList.remove('hidden');

                // Display accession ID
                document.getElementById('accession-id').textContent = accession.accession;

                // Display species information
                document.getElementById('species-genus').textContent = accession.species_genus;
                document.getElementById('species-name').textContent = ' ' + accession.species_name;

                if (accession.species_variety) {
                    document.getElementById('species-variety').textContent = ' var. ' + accession.species_variety;
                }

                if (accession.species_common_name) {
                    document.getElementById('species-common-name').textContent = accession.species_common_name;
                } else {
                    document.getElementById('species-common-name').classList.add('hidden');
                }

                // Set species link
                document.getElementById('species-link').href = buildUrl('organizations', organizationId, 'species', speciesId);

                // Display project information if available
                if (accession.project_id && accession.project_title) {
                    document.getElementById('project-container').classList.remove('hidden');
                    document.getElementById('project-title').textContent = accession.project_title;
                    document.getElementById('project-link').href = buildUrl('organizations', organizationId, 'projects', accession.project_id);
                }

                // Display description
                const description = accession.description;
                if (description && description.trim()) {
                    document.getElementById('accession-description').textContent = description;
                } else {
                    document.getElementById('accession-description').textContent = 'No description provided.';
                }

                // Display created date
                document.getElementById('accession-created').textContent = formatDate(accession.created_at);

                // Display custom field values if available
                if (accession.field_values && accession.field_values.length > 0) {
                    displayCustomFields(accession.field_values);
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError(error.message || 'Failed to load accession');
            }
        }

        function displayCustomFields(fieldValues) {
            const section = document.getElementById('custom-fields-section');
            const display = document.getElementById('custom-fields-display');

            // Show section even if some fields are empty (they exist in project)
            section.classList.remove('hidden');
            display.innerHTML = fieldValues.map(fieldValue => {
                const hasValue = fieldValue.value !== null && fieldValue.value !== undefined && fieldValue.value !== '';
                const value = hasValue ? fieldValue.value : 'Not set';
                const valueClass = hasValue ? 'text-gray-600' : 'text-gray-400 italic';

                return `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-1">${fieldValue.field_name}</h4>
                        <p class="${valueClass}">${value}</p>
                    </div>
                `;
            }).join('');
        }

        async function loadPlants() {
            try {
                const plants = await api.getPlants(organizationId, speciesId, accessionId);
                displayPlants(plants);
            } catch (error) {
                console.error('Error loading plants:', error);
                document.getElementById('plants-list').innerHTML = '<p class="text-red-500">Failed to load plants: ' + (error.message || error) + '</p>';
            }
        }

        function displayPlants(plants) {
            const plantsList = document.getElementById('plants-list');

            if (plants.length === 0) {
                plantsList.innerHTML = '<p class="text-gray-500 italic">No plants yet. Add one above!</p>';
                return;
            }

            plantsList.innerHTML = `
                <div class="space-y-2">
                    ${plants.map(plant => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100">
                            <a href="${buildUrl('organizations', organizationId, 'plants', plant.id)}"
                               class="text-blue-600 hover:underline font-medium">
                                ${plant.plant_id}
                            </a>
                            <span class="text-sm text-gray-500">
                                ${formatDate(plant.created_at)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadLocationTypes() {
            try {
                locationTypes = await api.getOrganizationLocationTypes(organizationId);
            } catch (error) {
                console.error('Failed to load location types:', error);
            }
        }

        function openAddPlantModal() {
            // Clear form
            document.getElementById('new-plant-id').value = '';
            document.getElementById('new-location-notes').value = '';
            document.getElementById('new-location-fields').innerHTML = '';
            document.getElementById('new-location-fields-container').classList.add('hidden');
            selectedLocationTypeForNewPlant = null;

            // Populate location type dropdown
            const locationTypeSelect = document.getElementById('new-location-type-select');
            locationTypeSelect.innerHTML = '<option value="">No location assigned</option>';

            locationTypes.forEach(locationType => {
                const option = document.createElement('option');
                option.value = locationType.id;
                option.textContent = locationType.location_name;
                locationTypeSelect.appendChild(option);
            });

            // Show modal
            document.getElementById('add-plant-modal').classList.remove('hidden');
        }

        function closeAddPlantModal() {
            document.getElementById('add-plant-modal').classList.add('hidden');
            selectedLocationTypeForNewPlant = null;
        }

        function handleNewPlantLocationTypeChange() {
            const locationTypeId = document.getElementById('new-location-type-select').value;
            const fieldsContainer = document.getElementById('new-location-fields-container');
            const fieldsDiv = document.getElementById('new-location-fields');

            if (!locationTypeId) {
                fieldsContainer.classList.add('hidden');
                fieldsDiv.innerHTML = '';
                selectedLocationTypeForNewPlant = null;
                return;
            }

            selectedLocationTypeForNewPlant = locationTypes.find(lt => lt.id === locationTypeId);
            if (!selectedLocationTypeForNewPlant) return;

            fieldsContainer.classList.remove('hidden');
            fieldsDiv.innerHTML = '';

            // Render fields for this location type
            selectedLocationTypeForNewPlant.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mb-2';

                const label = document.createElement('label');
                label.className = 'block text-xs font-medium text-gray-700 mb-1';
                label.textContent = field.field_name + (field.is_required ? ' *' : '');

                const input = document.createElement('input');
                input.type = field.field_type === 'NUMBER' ? 'number' : 'text';
                input.id = `new-location-field-${field.id}`;
                input.dataset.fieldId = field.id;
                input.dataset.fieldType = field.field_type;
                input.className = 'w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500';

                if (field.is_required) {
                    input.required = true;
                }

                if (field.field_type === 'NUMBER') {
                    if (field.min_value !== null) input.min = field.min_value;
                    if (field.max_value !== null) input.max = field.max_value;
                    input.step = 'any';
                } else {
                    if (field.min_length) input.minLength = field.min_length;
                    if (field.max_length) input.maxLength = field.max_length;
                }

                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                fieldsDiv.appendChild(fieldDiv);
            });
        }

        // Handle add plant form submission
        document.getElementById('add-plant-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const plantIdValue = document.getElementById('new-plant-id').value.trim();
            const locationTypeId = document.getElementById('new-location-type-select').value;

            if (!plantIdValue) {
                showError('Plant ID is required');
                return;
            }

            try {
                let locationId = null;

                // If a location type is selected, create the location
                if (locationTypeId && selectedLocationTypeForNewPlant) {
                    // Auto-generate location name from plant ID
                    const locationName = `Location for ${plantIdValue}`;
                    const locationNotes = document.getElementById('new-location-notes').value.trim();

                    // Collect field values
                    const fieldValues = [];
                    selectedLocationTypeForNewPlant.fields.forEach(field => {
                        const input = document.getElementById(`new-location-field-${field.id}`);
                        if (input) {
                            const value = input.value.trim();
                            if (value) {
                                fieldValues.push({
                                    field_id: field.id,
                                    value: field.field_type === 'NUMBER' ? parseFloat(value) : value
                                });
                            } else if (field.is_required) {
                                throw new Error(`${field.field_name} is required`);
                            }
                        }
                    });

                    // Create new location
                    const newLocation = await api.createLocation(organizationId, {
                        location_type_id: locationTypeId,
                        location_name: locationName,
                        notes: locationNotes || null,
                        field_values: fieldValues
                    });
                    locationId = newLocation.id;
                }

                // Create plant with location_id
                const plantData = {
                    plant_id: plantIdValue,
                    accession_id: accessionId,
                    location_id: locationId
                };

                await api.createPlant(organizationId, speciesId, accessionId, plantData);
                showSuccess('Plant added successfully!');
                closeAddPlantModal();

                // Reload plants
                await loadPlants();
            } catch (error) {
                showError(error.message || 'Failed to add plant');
            }
        });

        init();
    </script>
    <!-- Footer -->
    <div id="footer"></div>

</body>
</html>
