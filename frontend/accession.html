<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accession - RedBuds App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <div id="navigation"></div>

    <div class="container mx-auto px-4 py-8">

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">Loading accession...</p>
        </div>

        <!-- Accession content -->
        <div id="accession-content" class="hidden">
            <!-- Header with link back to species page -->
            <div class="mb-6">
                <a href="#" id="back-to-species" class="text-blue-600 hover:underline">‚Üê Back to Species</a>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 id="accession-id" class="text-3xl font-bold text-gray-800 mb-4"></h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Species</h3>
                        <p class="text-gray-600">
                            <a href="#" id="species-link" class="text-blue-600 hover:underline">
                                <span id="species-genus"></span>
                                <span id="species-name"></span>
                                <span id="species-variety" class="text-gray-600"></span>
                            </a>
                        </p>
                        <p id="species-common-name" class="text-sm text-gray-500 mt-1"></p>
                    </div>

                    <div id="project-container" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Project</h3>
                        <p class="text-gray-600">
                            <a href="#" id="project-link" class="text-blue-600 hover:underline">
                                <span id="project-title"></span>
                            </a>
                        </p>
                    </div>
                </div>

                <div id="description-container" class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Description</h3>
                    <p id="accession-description" class="text-gray-600">No description provided.</p>
                </div>

                <!-- Custom Fields Section -->
                <div id="custom-fields-section" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Custom Fields</h3>
                    <div id="custom-fields-display" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- Plants Section -->
                <div id="plants-section" class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Plants</h3>
                        <button id="add-plant-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                            Add Plant
                        </button>
                    </div>

                    <!-- Add Plant Form (hidden by default) -->
                    <div id="add-plant-form" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-700 mb-3">Add New Plant</h4>
                        <form id="plant-form" class="space-y-4">
                            <div>
                                <label for="plant_id" class="block text-sm font-medium text-gray-700 mb-1">Plant ID</label>
                                <input type="text" id="plant_id" name="plant_id" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                                    Save Plant
                                </button>
                                <button type="button" id="cancel-plant-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Plants List -->
                    <div id="plants-list">
                        <p class="text-gray-500 italic">Loading plants...</p>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-500">
                        Created: <span id="accession-created"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/navigation.js"></script>
    <script>
        let currentUser = null;
        let organizationId = null;
        let speciesId = null;
        let accessionId = null;
        let accession = null;

        async function init() {
            currentUser = await Auth.checkAuth();
            if (!currentUser) return;

            const params = new URLSearchParams(window.location.search);
            organizationId = params.get('org_id');
            speciesId = params.get('species_id');
            accessionId = params.get('id');

            if (!organizationId || !speciesId || !accessionId) {
                showError('Missing required parameters');
                return;
            }

            // Render navigation
            document.getElementById('navigation').innerHTML = navigation.render({ showOrgDropdown: true });
            navigation.init(currentUser, {
                showOrgDropdown: true,
                orgDropdownId: organizationId
            });
            document.getElementById('footer').innerHTML = navigation.renderFooter();

            // Set back link
            document.getElementById('back-to-species').href = `/species.html?org_id=${organizationId}&id=${speciesId}`;

            await loadAccession();
            await loadPlants();
            setupPlantHandlers();
        }

        async function loadAccession() {
            try {
                accession = await api.getAccession(organizationId, speciesId, accessionId);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('accession-content').classList.remove('hidden');

                // Display accession ID
                document.getElementById('accession-id').textContent = accession.accession;

                // Display species information
                document.getElementById('species-genus').textContent = accession.species_genus;
                document.getElementById('species-name').textContent = ' ' + accession.species_name;

                if (accession.species_variety) {
                    document.getElementById('species-variety').textContent = ' var. ' + accession.species_variety;
                }

                if (accession.species_common_name) {
                    document.getElementById('species-common-name').textContent = accession.species_common_name;
                } else {
                    document.getElementById('species-common-name').classList.add('hidden');
                }

                // Set species link
                document.getElementById('species-link').href = `/species.html?org_id=${organizationId}&id=${speciesId}`;

                // Display project information if available
                if (accession.project_id && accession.project_title) {
                    document.getElementById('project-container').classList.remove('hidden');
                    document.getElementById('project-title').textContent = accession.project_title;
                    document.getElementById('project-link').href = `/project.html?org_id=${organizationId}&id=${accession.project_id}`;
                }

                // Display description
                const description = accession.description;
                if (description && description.trim()) {
                    document.getElementById('accession-description').textContent = description;
                } else {
                    document.getElementById('accession-description').textContent = 'No description provided.';
                }

                // Display created date
                document.getElementById('accession-created').textContent = formatDate(accession.created_at);

                // Display custom field values if available
                if (accession.field_values && accession.field_values.length > 0) {
                    displayCustomFields(accession.field_values);
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError(error.message || 'Failed to load accession');
            }
        }

        function displayCustomFields(fieldValues) {
            const section = document.getElementById('custom-fields-section');
            const display = document.getElementById('custom-fields-display');

            // Show section even if some fields are empty (they exist in project)
            section.classList.remove('hidden');
            display.innerHTML = fieldValues.map(fieldValue => {
                const hasValue = fieldValue.value !== null && fieldValue.value !== undefined && fieldValue.value !== '';
                const value = hasValue ? fieldValue.value : 'Not set';
                const valueClass = hasValue ? 'text-gray-600' : 'text-gray-400 italic';

                return `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-1">${fieldValue.field_name}</h4>
                        <p class="${valueClass}">${value}</p>
                    </div>
                `;
            }).join('');
        }

        async function loadPlants() {
            try {
                const plants = await api.getPlants(organizationId, speciesId, accessionId);
                displayPlants(plants);
            } catch (error) {
                console.error('Error loading plants:', error);
                document.getElementById('plants-list').innerHTML = '<p class="text-red-500">Failed to load plants: ' + (error.message || error) + '</p>';
            }
        }

        function displayPlants(plants) {
            const plantsList = document.getElementById('plants-list');

            if (plants.length === 0) {
                plantsList.innerHTML = '<p class="text-gray-500 italic">No plants yet. Add one above!</p>';
                return;
            }

            plantsList.innerHTML = `
                <div class="space-y-2">
                    ${plants.map(plant => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100">
                            <a href="/plant.html?org_id=${organizationId}&species_id=${speciesId}&accession_id=${accessionId}&id=${plant.id}"
                               class="text-blue-600 hover:underline font-medium">
                                ${plant.plant_id}
                            </a>
                            <span class="text-sm text-gray-500">
                                ${formatDate(plant.created_at)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function setupPlantHandlers() {
            const addPlantBtn = document.getElementById('add-plant-btn');
            const cancelPlantBtn = document.getElementById('cancel-plant-btn');
            const plantForm = document.getElementById('plant-form');
            const addPlantFormContainer = document.getElementById('add-plant-form');

            addPlantBtn.addEventListener('click', () => {
                addPlantFormContainer.classList.remove('hidden');
                addPlantBtn.classList.add('hidden');
            });

            cancelPlantBtn.addEventListener('click', () => {
                addPlantFormContainer.classList.add('hidden');
                addPlantBtn.classList.remove('hidden');
                plantForm.reset();
            });

            plantForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Plant form submitted');

                const plantId = document.getElementById('plant_id').value.trim();
                console.log('Plant ID:', plantId);

                if (!plantId) {
                    showError('Plant ID is required');
                    return;
                }

                try {
                    console.log('Creating plant with data:', {
                        plant_id: plantId,
                        accession_id: accessionId
                    });

                    const result = await api.createPlant(organizationId, speciesId, accessionId, {
                        plant_id: plantId,
                        accession_id: accessionId
                    });

                    console.log('Plant created successfully:', result);
                    showSuccess('Plant added successfully');
                    plantForm.reset();
                    addPlantFormContainer.classList.add('hidden');
                    addPlantBtn.classList.remove('hidden');
                    await loadPlants();
                } catch (error) {
                    console.error('Error creating plant:', error);
                    showError(error.message || 'Failed to add plant');
                }
            });
        }

        init();
    </script>
    <!-- Footer -->
    <div id="footer"></div>

</body>
</html>
