<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization - RedBuds App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tabulator CSS and JS -->
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="/css/table-custom.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <div id="navigation"></div>

    <div class="container mx-auto px-4 py-8">

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Loading organization...</p>
        </div>

        <!-- Organization content -->
        <div id="organization-content" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="org-name" class="text-3xl font-bold text-gray-800"></h2>
                        <p id="org-created" class="text-gray-600 mt-2"></p>
                    </div>
                    <a href="#" id="admin-link" class="hidden bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Manage Organization
                    </a>
                </div>

                <div id="org-description-container" class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">About</h3>
                    <p id="org-description" class="text-gray-600">No description provided.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 pt-6 border-t border-gray-200">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Total Members</p>
                        <p id="member-count" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Your Role</p>
                        <p id="user-role" class="text-2xl font-bold text-blue-600">Member</p>
                    </div>
                </div>
            </div>

            <!-- Projects List -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Projects</h3>
                    <button id="add-project-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Add Project
                    </button>
                </div>
                <div id="projects-table">
                    <!-- Projects table will be initialized here -->
                </div>
            </div>

            <!-- Species List -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Species</h3>
                    <button id="add-species-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Add Species
                    </button>
                </div>
                <div id="species-table">
                    <!-- Species table will be initialized here -->
                </div>
            </div>

            <!-- Accessions List -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Accessions</h3>
                    <button id="add-accession-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Add Accession
                    </button>
                </div>
                <div id="accessions-table">
                    <!-- Accessions table will be initialized here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Species Modal -->
    <div id="species-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="species-modal-title" class="text-lg font-bold text-gray-900">Add Species</h3>
                <button id="close-species-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="species-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="genus">
                        Genus *
                    </label>
                    <input type="text" id="genus" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="species_name">
                        Species *
                    </label>
                    <input type="text" id="species_name" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="variety">
                        Variety
                    </label>
                    <input type="text" id="variety"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="common_name">
                        Common Name
                    </label>
                    <input type="text" id="common_name"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="description">
                        Description
                    </label>
                    <textarea id="description" rows="3"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-species-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="project-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="project-modal-title" class="text-lg font-bold text-gray-900">Add Project</h3>
                <button id="close-project-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="project-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="project-title">
                        Project Title *
                    </label>
                    <input type="text" id="project-title" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="project-description">
                        Description
                    </label>
                    <textarea id="project-description" rows="3"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-project-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Project Confirmation Modal -->
    <div id="delete-project-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="if(event.target === this) closeDeleteProjectModal()">
        <div class="relative top-20 mx-auto p-5 border w-auto max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Confirm Delete</h3>
                <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete this project? This action cannot be undone by organization admins.</p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteProjectModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="confirm-delete-project-btn" onclick="confirmDeleteProject()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Accession Modal -->
    <div id="accession-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="accession-modal-title" class="text-lg font-bold text-gray-900">Add Accession</h3>
                <button id="close-accession-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="accession-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="accession-species">
                        Species *
                    </label>
                    <select id="accession-species" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Select a species...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="accession-project">
                        Project (Optional)
                    </label>
                    <select id="accession-project"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="accession-id">
                        Accession ID *
                    </label>
                    <input type="text" id="accession-id" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="accession-description">
                        Description
                    </label>
                    <textarea id="accession-description" rows="3"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>

                <!-- Custom Fields Container -->
                <div id="custom-fields-container" class="hidden mb-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 border-t pt-3">Custom Fields</h4>
                    <div id="custom-fields-list"></div>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-accession-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/table.js"></script>
    <script src="/js/tableBuilder.js"></script>
    <script>
        let currentUser = null;
        let organizationId = null;
        let organization = null;
        let projectsTable = null;
        let speciesTable = null;
        let accessionsTable = null;
        let editingSpeciesId = null;
        let editingAccessionId = null;
        let isAdmin = false;
        let allSpecies = [];
        let allProjects = [];
        let projectFields = [];
        let currentAccessionFieldValues = [];

        async function init() {
            currentUser = await Auth.checkAuth();
            if (!currentUser) return;

            const params = new URLSearchParams(window.location.search);
            organizationId = params.get('id');

            if (!organizationId) {
                showError('No organization ID provided');
                return;
            }

            // Render navigation
            document.getElementById('navigation').innerHTML = navigation.render({ showOrgDropdown: true });
            navigation.init(currentUser, {
            document.getElementById('footer').innerHTML = navigation.renderFooter();
                showOrgDropdown: true,
                orgDropdownId: organizationId
            });

            await loadOrganization();
        }

        async function loadOrganization() {
            try {
                organization = await api.getOrganization(organizationId);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('organization-content').classList.remove('hidden');

                document.getElementById('org-name').textContent = organization.name;
                document.getElementById('org-created').textContent = `Created: ${formatDate(organization.created_at)}`;

                // Display description
                const description = organization.description;
                if (description && description.trim()) {
                    document.getElementById('org-description').textContent = description;
                } else {
                    document.getElementById('org-description').textContent = 'No description provided.';
                }

                // Display member count and user role (only count active members)
                const activeMembers = organization.members.filter(m => m.status === 'Active');
                document.getElementById('member-count').textContent = activeMembers.length;

                const userMembership = organization.members.find(m => m.user_id === currentUser.id);
                if (userMembership) {
                    document.getElementById('user-role').textContent = userMembership.role.charAt(0).toUpperCase() + userMembership.role.slice(1);
                } else if (currentUser.is_site_admin) {
                    document.getElementById('user-role').textContent = 'Site Admin';
                } else {
                    document.getElementById('user-role').textContent = 'Guest';
                }

                // Show admin link if user is admin and active
                isAdmin = (userMembership && userMembership.role === 'admin' && userMembership.status === 'Active') || currentUser.is_site_admin;
                if (isAdmin) {
                    const adminLink = document.getElementById('admin-link');
                    adminLink.href = `/org-admin.html?id=${organizationId}`;
                    adminLink.classList.remove('hidden');

                    // Update navigation dropdown link
                    const orgAdminMenuLink = document.getElementById('org-admin-menu-link');
                    if (orgAdminMenuLink) {
                        orgAdminMenuLink.href = `/org-admin.html?id=${organizationId}`;
                        orgAdminMenuLink.classList.remove('hidden');
                    }
                }

                // Load projects, species, and accessions
                await loadProjects();
                await loadSpecies();
                await loadAccessions();
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError(error.message || 'Failed to load organization');
            }
        }

        async function loadProjects() {
            try {
                allProjects = await api.getProjects(organizationId);

                // Sort projects: active first, then archived, then deleted, alphabetically within each group
                const statusOrder = { 'active': 0, 'archived': 1, 'deleted': 2 };
                allProjects.sort((a, b) => {
                    // First sort by status
                    const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                    if (statusDiff !== 0) return statusDiff;

                    // Then sort alphabetically by title
                    return a.title.localeCompare(b.title);
                });

                // Show add button for admins
                if (isAdmin) {
                    document.getElementById('add-project-btn').classList.remove('hidden');
                }

                // Define columns with clickable title and status badge
                const columns = [
                    {
                        field: 'title',
                        label: 'Project Title',
                        visible: true,
                        sortable: true,
                        width: 300,
                        formatter: (cell) => {
                            const project = cell.getData();
                            const container = document.createElement('div');
                            container.className = 'flex items-center gap-2';

                            // Create clickable link
                            const link = document.createElement('a');
                            link.href = `/project.html?org_id=${organizationId}&id=${project.id}`;
                            link.className = 'text-blue-600 hover:underline font-medium';
                            link.textContent = project.title;

                            container.appendChild(link);

                            // Add status badge if archived or deleted
                            if (project.status === 'archived') {
                                const badge = document.createElement('span');
                                badge.className = 'text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded';
                                badge.textContent = 'Archived';
                                container.appendChild(badge);
                            } else if (project.status === 'deleted') {
                                const badge = document.createElement('span');
                                badge.className = 'text-xs px-2 py-1 bg-red-100 text-red-800 rounded';
                                badge.textContent = 'Deleted';
                                container.appendChild(badge);
                            }

                            return container;
                        }
                    },
                    {
                        field: 'description',
                        label: 'Description',
                        visible: true,
                        sortable: false,
                        width: 400,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'created_at',
                        label: 'Created',
                        visible: true,
                        sortable: true,
                        width: 180,
                        formatter: 'datetime'
                    }
                ];

                // Add actions column if user is admin
                if (isAdmin) {
                    columns.push({
                        field: 'actions',
                        label: 'Actions',
                        visible: true,
                        sortable: false,
                        width: 200,
                        formatter: (cell) => {
                            const project = cell.getData();
                            const isActive = project.status === 'active';
                            const isArchived = project.status === 'archived';
                            const isDeleted = project.status === 'deleted';

                            const container = document.createElement('div');
                            container.className = 'flex gap-2';

                            if (isActive) {
                                // Archive button
                                const archiveBtn = document.createElement('button');
                                archiveBtn.className = 'text-yellow-600 hover:text-yellow-800 text-sm font-medium';
                                archiveBtn.textContent = 'Archive';
                                archiveBtn.onclick = () => archiveProject(project.id);
                                container.appendChild(archiveBtn);

                                // Delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm font-medium';
                                deleteBtn.textContent = 'Delete';
                                deleteBtn.onclick = () => showDeleteProjectModal(project.id);
                                container.appendChild(deleteBtn);
                            } else if (isArchived) {
                                // Unarchive button
                                const unarchiveBtn = document.createElement('button');
                                unarchiveBtn.className = 'text-green-600 hover:text-green-800 text-sm font-medium';
                                unarchiveBtn.textContent = 'Unarchive';
                                unarchiveBtn.onclick = () => unarchiveProject(project.id);
                                container.appendChild(unarchiveBtn);

                                // Delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm font-medium';
                                deleteBtn.textContent = 'Delete';
                                deleteBtn.onclick = () => showDeleteProjectModal(project.id);
                                container.appendChild(deleteBtn);
                            } else if (isDeleted && currentUser.is_site_admin) {
                                // Undelete button (only for site admins)
                                const undeleteBtn = document.createElement('button');
                                undeleteBtn.className = 'text-blue-600 hover:text-blue-800 text-sm font-medium';
                                undeleteBtn.textContent = 'Undelete';
                                undeleteBtn.onclick = () => undeleteProject(project.id);
                                container.appendChild(undeleteBtn);
                            }

                            return container;
                        }
                    });
                }

                const config = {
                    visible_columns: columns
                };

                // Create table instance if it doesn't exist
                if (!projectsTable) {
                    projectsTable = new DataTable('#projects-table', {
                        pageSize: 20,
                        rowFormatter: (row) => {
                            const data = row.getData();
                            if (data.status === 'archived' || data.status === 'deleted') {
                                row.getElement().style.opacity = '0.5';
                            }
                        }
                    });
                }

                projectsTable.init(allProjects, config);
            } catch (error) {
                console.error('Failed to load projects:', error);
                showError('Failed to load projects');
            }
        }

        async function loadSpecies() {
            try {
                allSpecies = await api.getSpecies(organizationId);

                // Define columns
                const columns = [
                    {
                        field: 'genus',
                        label: 'Genus',
                        visible: true,
                        sortable: true,
                        width: 150,
                        formatter: (cell) => {
                            const speciesData = cell.getData();
                            const link = document.createElement('a');
                            link.href = `/species.html?org_id=${organizationId}&id=${speciesData.id}`;
                            link.className = 'text-blue-600 hover:underline font-medium';
                            link.textContent = speciesData.genus;
                            return link;
                        }
                    },
                    {
                        field: 'species_name',
                        label: 'Species',
                        visible: true,
                        sortable: true,
                        width: 150,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'variety',
                        label: 'Variety',
                        visible: true,
                        sortable: true,
                        width: 150,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'common_name',
                        label: 'Common Name',
                        visible: true,
                        sortable: true,
                        width: 200,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'description',
                        label: 'Description',
                        visible: true,
                        sortable: false,
                        width: 300,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'created_at',
                        label: 'Created',
                        visible: true,
                        sortable: true,
                        width: 180,
                        formatter: 'datetime'
                    }
                ];

                // Add actions column if user is admin
                if (isAdmin) {
                    columns.push({
                        field: 'actions',
                        label: 'Actions',
                        visible: true,
                        sortable: false,
                        width: 120,
                        formatter: (cell) => {
                            const speciesData = cell.getData();
                            const container = document.createElement('div');
                            container.className = 'flex gap-2';

                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Edit';
                            editBtn.className = 'text-blue-600 hover:underline text-sm';
                            editBtn.onclick = () => openSpeciesModal(speciesData);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.className = 'text-red-600 hover:underline text-sm';
                            deleteBtn.onclick = () => deleteSpecies(speciesData.id);

                            container.appendChild(editBtn);
                            container.appendChild(deleteBtn);

                            return container;
                        }
                    });

                    // Show add button
                    document.getElementById('add-species-btn').classList.remove('hidden');
                }

                const config = {
                    visible_columns: columns,
                    default_sort: { field: 'genus', dir: 'asc' }
                };

                // Create table instance if it doesn't exist
                if (!speciesTable) {
                    speciesTable = new DataTable('#species-table', {
                        pageSize: 20
                    });
                }

                speciesTable.init(allSpecies, config);
            } catch (error) {
                console.error('Failed to load species:', error);
                showError('Failed to load species');
            }
        }

        function openSpeciesModal(speciesData = null) {
            editingSpeciesId = speciesData ? speciesData.id : null;
            const modal = document.getElementById('species-modal');
            const form = document.getElementById('species-form');
            const title = document.getElementById('species-modal-title');

            if (speciesData) {
                title.textContent = 'Edit Species';
                document.getElementById('genus').value = speciesData.genus || '';
                document.getElementById('species_name').value = speciesData.species_name || '';
                document.getElementById('variety').value = speciesData.variety || '';
                document.getElementById('common_name').value = speciesData.common_name || '';
                document.getElementById('description').value = speciesData.description || '';
            } else {
                title.textContent = 'Add Species';
                form.reset();
            }

            modal.classList.remove('hidden');
        }

        function closeSpeciesModal() {
            document.getElementById('species-modal').classList.add('hidden');
            document.getElementById('species-form').reset();
            editingSpeciesId = null;
        }

        async function handleSpeciesFormSubmit(e) {
            e.preventDefault();

            const data = {
                genus: document.getElementById('genus').value,
                species_name: document.getElementById('species_name').value,
                variety: document.getElementById('variety').value || null,
                common_name: document.getElementById('common_name').value || null,
                description: document.getElementById('description').value || null
            };

            try {
                if (editingSpeciesId) {
                    await api.updateSpecies(organizationId, editingSpeciesId, data);
                    showSuccess('Species updated successfully');
                } else {
                    await api.createSpecies(organizationId, data);
                    showSuccess('Species created successfully');
                }

                closeSpeciesModal();
                await loadSpecies();
            } catch (error) {
                showError(error.message || 'Failed to save species');
            }
        }

        async function deleteSpecies(speciesId) {
            if (!confirm('Are you sure you want to delete this species?')) {
                return;
            }

            try {
                await api.deleteSpecies(organizationId, speciesId);
                showSuccess('Species deleted successfully');
                await loadSpecies();
            } catch (error) {
                showError(error.message || 'Failed to delete species');
            }
        }

        // Project modal functions
        function openProjectModal() {
            const modal = document.getElementById('project-modal');
            const form = document.getElementById('project-form');
            form.reset();
            modal.classList.remove('hidden');
        }

        function closeProjectModal() {
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('project-form').reset();
        }

        async function handleProjectFormSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('project-title').value.trim();
            const description = document.getElementById('project-description').value.trim();

            if (!title) {
                showError('Project title is required');
                return;
            }

            try {
                await api.createProject(organizationId, title, description || null);
                showSuccess('Project created successfully');
                closeProjectModal();
                await loadProjects();
            } catch (error) {
                showError(error.message || 'Failed to create project');
            }
        }

        // Project action functions
        let deleteProjectId = null;

        function showDeleteProjectModal(projectId) {
            deleteProjectId = projectId;
            document.getElementById('delete-project-modal').classList.remove('hidden');
        }

        function closeDeleteProjectModal() {
            deleteProjectId = null;
            document.getElementById('delete-project-modal').classList.add('hidden');
        }

        async function confirmDeleteProject() {
            if (!deleteProjectId) return;

            try {
                await api.deleteProject(organizationId, deleteProjectId);
                showSuccess('Project deleted successfully!');
                closeDeleteProjectModal();
                await loadProjects();
            } catch (error) {
                showError(error.message || 'Failed to delete project');
                closeDeleteProjectModal();
            }
        }

        async function archiveProject(projectId) {
            try {
                await api.archiveProject(organizationId, projectId);
                showSuccess('Project archived successfully!');
                await loadProjects();
            } catch (error) {
                showError(error.message || 'Failed to archive project');
            }
        }

        async function unarchiveProject(projectId) {
            try {
                await api.unarchiveProject(organizationId, projectId);
                showSuccess('Project unarchived successfully!');
                await loadProjects();
            } catch (error) {
                showError(error.message || 'Failed to unarchive project');
            }
        }

        async function undeleteProject(projectId) {
            try {
                await api.undeleteProject(organizationId, projectId);
                showSuccess('Project undeleted successfully!');
                await loadProjects();
            } catch (error) {
                showError(error.message || 'Failed to undelete project');
            }
        }

        // Accession functions
        async function loadAccessions() {
            try {
                const accessions = await api.getAllAccessions(organizationId);

                // Show add button for admins
                if (isAdmin) {
                    document.getElementById('add-accession-btn').classList.remove('hidden');
                }

                // Define columns
                const columns = [
                    {
                        field: 'accession',
                        label: 'Accession',
                        visible: true,
                        sortable: true,
                        width: 150,
                        formatter: (cell) => {
                            const data = cell.getData();
                            const link = document.createElement('a');
                            link.href = `/accession.html?org_id=${organizationId}&species_id=${data.species_id}&id=${data.id}`;
                            link.className = 'text-blue-600 hover:underline font-medium';
                            link.textContent = data.accession;
                            return link;
                        }
                    },
                    {
                        field: 'species_genus',
                        label: 'Species',
                        visible: true,
                        sortable: true,
                        width: 200,
                        formatter: (cell) => {
                            const data = cell.getData();
                            let text = `${data.species_genus} ${data.species_name}`;
                            if (data.species_variety) {
                                text += ` var. ${data.species_variety}`;
                            }
                            return text;
                        }
                    },
                    {
                        field: 'project_title',
                        label: 'Project',
                        visible: true,
                        sortable: true,
                        width: 150,
                        formatter: (cell) => {
                            const data = cell.getData();
                            return data.project_title || '-';
                        }
                    },
                    {
                        field: 'description',
                        label: 'Description',
                        visible: true,
                        sortable: false,
                        width: 300,
                        formatter: 'plaintext'
                    },
                    {
                        field: 'created_at',
                        label: 'Created',
                        visible: true,
                        sortable: true,
                        width: 180,
                        formatter: 'datetime'
                    }
                ];

                // Add actions column if user is admin
                if (isAdmin) {
                    columns.push({
                        field: 'actions',
                        label: 'Actions',
                        visible: true,
                        sortable: false,
                        width: 120,
                        formatter: (cell) => {
                            const accessionData = cell.getData();
                            const container = document.createElement('div');
                            container.className = 'flex gap-2';

                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Edit';
                            editBtn.className = 'text-blue-600 hover:underline text-sm';
                            editBtn.onclick = () => openAccessionModal(accessionData);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.className = 'text-red-600 hover:underline text-sm';
                            deleteBtn.onclick = () => deleteAccession(accessionData.id);

                            container.appendChild(editBtn);
                            container.appendChild(deleteBtn);

                            return container;
                        }
                    });
                }

                const config = {
                    visible_columns: columns,
                    default_sort: { field: 'accession', dir: 'asc' }
                };

                // Create table instance if it doesn't exist
                if (!accessionsTable) {
                    accessionsTable = new DataTable('#accessions-table', {
                        pageSize: 20
                    });
                }

                accessionsTable.init(accessions, config);
            } catch (error) {
                console.error('Failed to load accessions:', error);
                showError('Failed to load accessions');
            }
        }

        async function loadProjectFields(projectId) {
            if (!projectId) {
                projectFields = [];
                document.getElementById('custom-fields-container').classList.add('hidden');
                return;
            }

            try {
                projectFields = await api.getProjectFields(organizationId, projectId);
                renderCustomFields();
            } catch (error) {
                console.error('Failed to load project fields:', error);
                projectFields = [];
            }
        }

        function renderCustomFields() {
            const container = document.getElementById('custom-fields-container');
            const fieldsList = document.getElementById('custom-fields-list');

            if (projectFields.length === 0) {
                container.classList.add('hidden');
                fieldsList.innerHTML = '';
                return;
            }

            container.classList.remove('hidden');
            fieldsList.innerHTML = projectFields.map(field => {
                const fieldId = `custom-field-${field.id}`;
                const requiredMark = field.is_required ? ' *' : '';
                let inputHtml = '';

                if (field.field_type === 'string') {
                    const attrs = [];
                    if (field.min_length) attrs.push(`minlength="${field.min_length}"`);
                    if (field.max_length) attrs.push(`maxlength="${field.max_length}"`);
                    if (field.regex_pattern) attrs.push(`pattern="${field.regex_pattern}"`);
                    if (field.is_required) attrs.push('required');

                    inputHtml = `<input type="text" id="${fieldId}" data-field-id="${field.id}" data-field-type="string"
                        class="custom-field-input shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        ${attrs.join(' ')}>`;
                } else if (field.field_type === 'number') {
                    const attrs = [];
                    if (field.min_value !== null && field.min_value !== undefined) attrs.push(`min="${field.min_value}"`);
                    if (field.max_value !== null && field.max_value !== undefined) attrs.push(`max="${field.max_value}"`);
                    if (field.is_required) attrs.push('required');

                    inputHtml = `<input type="number" step="any" id="${fieldId}" data-field-id="${field.id}" data-field-type="number"
                        class="custom-field-input shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        ${attrs.join(' ')}>`;
                }

                return `
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="${fieldId}">
                            ${field.field_name}${requiredMark}
                        </label>
                        ${inputHtml}
                    </div>
                `;
            }).join('');

            // Populate existing values if editing
            if (currentAccessionFieldValues.length > 0) {
                currentAccessionFieldValues.forEach(fieldValue => {
                    const input = document.querySelector(`[data-field-id="${fieldValue.field_id}"]`);
                    if (input) {
                        input.value = fieldValue.value || '';
                    }
                });
            }
        }

        function collectFieldValues() {
            const fieldInputs = document.querySelectorAll('.custom-field-input');
            const fieldValues = [];

            fieldInputs.forEach(input => {
                const fieldId = input.dataset.fieldId;
                const fieldType = input.dataset.fieldType;
                let value = input.value;

                if (value) {
                    if (fieldType === 'number') {
                        value = parseFloat(value);
                    }
                    fieldValues.push({
                        field_id: fieldId,
                        value: value
                    });
                }
            });

            return fieldValues;
        }

        async function openAccessionModal(accessionData = null) {
            editingAccessionId = accessionData ? accessionData.id : null;
            currentAccessionFieldValues = [];
            const modal = document.getElementById('accession-modal');
            const form = document.getElementById('accession-form');
            const title = document.getElementById('accession-modal-title');

            // Populate species dropdown
            const speciesSelect = document.getElementById('accession-species');
            speciesSelect.innerHTML = '<option value="">Select a species...</option>';
            allSpecies.forEach(species => {
                const option = document.createElement('option');
                option.value = species.id;
                option.textContent = `${species.genus} ${species.species_name}${species.variety ? ' var. ' + species.variety : ''}`;
                speciesSelect.appendChild(option);
            });

            // Populate projects dropdown (only active projects)
            const projectSelect = document.getElementById('accession-project');
            projectSelect.innerHTML = '<option value="">None</option>';
            const activeProjects = allProjects.filter(p => p.status === 'active');
            activeProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.title;
                projectSelect.appendChild(option);
            });

            if (accessionData) {
                title.textContent = 'Edit Accession';
                document.getElementById('accession-species').value = accessionData.species_id || '';
                document.getElementById('accession-project').value = accessionData.project_id || '';
                document.getElementById('accession-id').value = accessionData.accession || '';
                document.getElementById('accession-description').value = accessionData.description || '';

                // Load field values if editing
                if (accessionData.field_values) {
                    currentAccessionFieldValues = accessionData.field_values;
                }

                // Load custom fields if project is set
                if (accessionData.project_id) {
                    await loadProjectFields(accessionData.project_id);
                }
            } else {
                title.textContent = 'Add Accession';
                form.reset();
                // Re-populate dropdowns after reset
                speciesSelect.innerHTML = '<option value="">Select a species...</option>';
                allSpecies.forEach(species => {
                    const option = document.createElement('option');
                    option.value = species.id;
                    option.textContent = `${species.genus} ${species.species_name}${species.variety ? ' var. ' + species.variety : ''}`;
                    speciesSelect.appendChild(option);
                });
                projectSelect.innerHTML = '<option value="">None</option>';
                activeProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.title;
                    projectSelect.appendChild(option);
                });
            }

            modal.classList.remove('hidden');
        }

        function closeAccessionModal() {
            document.getElementById('accession-modal').classList.add('hidden');
            document.getElementById('accession-form').reset();
            editingAccessionId = null;
        }

        async function handleAccessionFormSubmit(e) {
            e.preventDefault();

            const speciesId = document.getElementById('accession-species').value;
            const projectId = document.getElementById('accession-project').value;
            const accessionIdValue = document.getElementById('accession-id').value;
            const description = document.getElementById('accession-description').value;

            if (!speciesId) {
                showError('Please select a species');
                return;
            }

            const data = {
                species_id: speciesId,
                accession: accessionIdValue,
                description: description || null,
                project_id: projectId || null
            };

            // Collect custom field values if project is selected
            if (projectId && projectFields.length > 0) {
                const fieldValues = collectFieldValues();
                if (fieldValues.length > 0) {
                    data.field_values = fieldValues;
                }
            }

            try {
                if (editingAccessionId) {
                    await api.updateOrgAccession(organizationId, editingAccessionId, data);
                    showSuccess('Accession updated successfully');
                } else {
                    await api.createOrgAccession(organizationId, data);
                    showSuccess('Accession created successfully');
                }

                closeAccessionModal();
                await loadAccessions();
            } catch (error) {
                showError(error.message || 'Failed to save accession');
            }
        }

        async function deleteAccession(accessionId) {
            if (!confirm('Are you sure you want to delete this accession?')) {
                return;
            }

            try {
                await api.deleteOrgAccession(organizationId, accessionId);
                showSuccess('Accession deleted successfully');
                await loadAccessions();
            } catch (error) {
                showError(error.message || 'Failed to delete accession');
            }
        }

        // Event listeners
        document.getElementById('add-species-btn').addEventListener('click', () => openSpeciesModal());
        document.getElementById('close-species-modal').addEventListener('click', closeSpeciesModal);
        document.getElementById('cancel-species-btn').addEventListener('click', closeSpeciesModal);
        document.getElementById('species-form').addEventListener('submit', handleSpeciesFormSubmit);

        document.getElementById('add-project-btn').addEventListener('click', () => openProjectModal());
        document.getElementById('close-project-modal').addEventListener('click', closeProjectModal);
        document.getElementById('cancel-project-btn').addEventListener('click', closeProjectModal);
        document.getElementById('project-form').addEventListener('submit', handleProjectFormSubmit);

        document.getElementById('add-accession-btn').addEventListener('click', () => openAccessionModal());
        document.getElementById('close-accession-modal').addEventListener('click', closeAccessionModal);
        document.getElementById('cancel-accession-btn').addEventListener('click', closeAccessionModal);
        document.getElementById('accession-form').addEventListener('submit', handleAccessionFormSubmit);

        // Project dropdown change handler to load custom fields
        document.getElementById('accession-project').addEventListener('change', async (e) => {
            const projectId = e.target.value;
            currentAccessionFieldValues = []; // Clear existing values when switching projects
            await loadProjectFields(projectId);
        });

        init();
    </script>
    <!-- Footer -->
    <div id="footer"></div>

</body>
</html>
